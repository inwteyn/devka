(function(b,g){g.PhotoViewer={is_setup:!1,c:null,is_viewer:!1,last_scroll_top:0,timeout:null,total_count:0,photos:{},album_title:"",album_href:"",owner_title:"",owner_href:"",slideshow_is_stop:!0,slideshow_is_pause:!1,scale:1,move:{top:0,left:0},comments:{},options:{album_id:0,photo_id:0,isPage:0,slideshow_time:3E3,min_scale:1,max_scale:3,scale_step:10,events:0},open:function(a){var c=this;this.options.album_id=a.album_id;this.options.photo_id=a.photo_id;this.options.isPage=a.isPage;this.options.events=
a.events;this.setup();c.last_scroll_top=b(g).scrollTop();this.viewer();this.reset();c.viewer().addClass("active");setTimeout(function(){b(g).scrollTop(0);b("html").addClass("hideScroll");c.resize();c.loadPhoto()},10);this.old_comments_block=b("#comments");this.setIdPrefix(this.old_comments_block)},hide:function(){this.viewer().hasClass("fullmode")?this.fullHide():(this.viewer().removeClass("active"),b("html").removeClass("hideScroll"),b(g).scrollTop(this.last_scroll_top),this.removeIdPrefix(this.old_comments_block),
$$(".wpPhotoOptions").setStyle("display","none"))},resize:function(){var a=b(g).width(),c=b(g).height();this.viewer().hasClass("fullmode")?(b("#wpPhotoViewer").find(".wpPhotoContent, .wpCommentsContent").css("height",c),b("#wpPhotoViewer").find(".wpPhoto").css("width",a),b("#wpPhotoViewer").find(".wpNext, .wpPrev").css("right",0)):(a-=50,c-=50,b("#wpPhotoViewer").find(".wpPhotoContent, .wpCommentsContent").css("height",c-70),b("#wpPhotoViewer").find(".wpPhoto").css("width",a-400),b("#wpPhotoViewer").find(".wpComments").css("width",
397),b("#wpPhotoViewer").find(".wpNext, .wpPrev").css("right",390));b("#wpPhotoViewer").find(".wpNext, .wpPrev").css("line-height",c+"px");0<this.viewer().find(".photos").width()-100*this.total_count?this.viewer().find(".wpPhotoList").addClass("one_col"):this.viewer().find(".wpPhotoList").removeClass("one_col");this.hideOptions()},loadPhoto:function(){var a=this;b.ajax({url:en4.core.baseUrl+"photoviewer",data:{format:"json",photo_id:this.options.photo_id,isPage:this.options.isPage,events:this.options.events},
success:function(c){if(c&&c.photos){a.total_count=c.count;a.album_title=c.album_title;a.album_href=c.album_href;a.owner_title=c.owner_title;a.owner_href=c.owner_href;a.photos={};var d=0,e="";b(c.photos).each(function(c,b){e+='<a href="javascript:void(0);" class="wpPhotoItem" onclick="PhotoViewer.view('+b.photo_id+');" id="wp_'+b.photo_id+'"><img id="fullphoto_'+b.photo_id+'" src="'+b.thumb+'" alt=""/></a>';a.photos[b.photo_id]=b;0==c&&(d=b.photo_id);b.active&&(d=b.photo_id)});a.viewer().find(".wpPhotoList").find(".photos").html(e);
a.viewer().find(".wpPhotoList").find(".photos").find("img").load(function(){b(this).addClass("loaded")});a.viewer().find(".wpPhotoList").find(".count").html(a.total_count);1<a.total_count&&a.viewer().find(".allPhotos").show();a.viewer().find(".goSlideshow").show();a.view(d);a._checkPagination();a.resize()}}})},view:function(a){if(this.photos[a]){var c=this.photos[a];this.viewer().find(".wpPhotoItem").removeClass("active");this.viewer().find("#wp_"+a).addClass("active");var d=this.viewer().find("#wp_"+
a).prevAll().length+1,e=this.viewer().find(".wpPhotoContent");e.find(".active").removeClass("active").removeClass("fade");var f=e.find("#thephoto_"+a);f.length?(f.addClass("active"),setTimeout(function(){f.addClass("fade")},10)):(e.append(b('<div class="thephoto" id="thephoto_'+a+'"><div class="moveElement"><div id="imgPlace_'+a+'"><img src="'+c.src+'" alt=""/></div><span class="photo_options"><a href="javascript:void(0);" class="openfull hei hei-expand" onclick="PhotoViewer.fullOpen();"></a><a href="javascript:void(0);" class="hidefull icon-compress" onclick="PhotoViewer.fullHide();"></a></span></div></div>')),
f=b("#thephoto_"+a),clearTimeout(this.photo),this.photo=setTimeout(function(){f.addClass("active");setTimeout(function(){f.addClass("fade")},10)},10));this.resize();this.viewer().find(".wpPhotoOptions").find(".info").show();c=this.viewer().find(".wpPhotoOptions").find(".album_info");c.find(".album_title").html('<a href="'+this.album_href+'">'+this.album_title+"</a>");c.find(".album_owner").html(' - <a href="'+this.owner_href+'">'+this.owner_title+"</a>");this.viewer().find(".wpPhotoOptions").find(".count").find(".total").html(this.total_count);
this.viewer().find(".wpPhotoOptions").find(".count").find(".current").html(d);this.loadComments(a);this._checkPagination()}},_checkPagination:function(){var a=this.viewer().find(".wpNext"),b=this.viewer().find(".wpPrev");if(2>this.total_count)a.hide(),b.hide();else{var d=this.viewer().find(".wpPhotoItem.active");d.prev().length?b.show():b.hide();d.next().length?a.show():a.hide()}},next:function(a){var b=this.viewer().find(".wpPhotoItem.active");b.next().length?b.next().click():a?a():this.showList();
this._checkPagination()},prev:function(){var a=this.viewer().find(".wpPhotoItem.active");a.prev().length?a.prev().click():this.showList();this._checkPagination()},toggleList:function(){this.viewer().find(".wpPhotoList").hasClass("active")?this.hideList():this.showList()},showList:function(){!(2>this.total_count)&&!this.viewer().hasClass("fullmode")&&(this.viewer().find(".photos").jScrollPane(),this.viewer().find(".wpPhotoList").addClass("active"),this.showOver())},isListActive:function(){return this.viewer().find(".wpPhotoList").hasClass("active")},
hideList:function(){this.viewer().find(".wpPhotoList").removeClass("active");this.hideOver()},loadComments:function(a){var c=this;c.showLoading();this.comment_request=b.ajax({url:en4.core.baseUrl+"photoviewer/index/comments",data:{format:"html",photo_id:a,isPage:this.options.isPage,events:this.options.events},success:function(d){c.hideLoading();c.setIdPrefix(c.viewer().find(".wpCommentsContent").find(".photo_comment").hide());var e=b("<div />").attr({id:"photo_comment_"+a,"class":"photo_comment"});
e.html(d);c.viewer().find(".wpCommentsContent").append(e);en4.core.runonce.trigger();Smoothbox.bind($("photo_comment_"+a))}})},setIdPrefix:function(a){a.find("*[id]").not(".iswphprefix").add(a).each(function(a,d){b(d).attr("id","wphPrefix"+(1E3*Math.random()).toInt()+"wphEnd"+b(d).attr("id"));b(d).addClass("iswphprefix")})},removeIdPrefix:function(a){a.find(".iswphprefix").add(a).each(function(a,d){var e=b(d).attr("id"),f=e.indexOf("wphEnd");-1!==f&&(e=e.substr(f+6),b(d).attr("id",e),b(d).removeClass("iswphprefix"))})},
onError:function(a){alert(a)},setup:function(){var a=this;if(!this.is_setup){this.is_setup=!0;b(g).resize(function(){a.resize()});var c="keypress";if(Browser.Engine.trident||Browser.Engine.webkit)c="keydown";b(document).bind(c,function(d){var c=b(d.target).prop("tagName").toLowerCase();"textarea"==c||"input"==c||"select"==c||a.isListActive()||(37==d.keyCode?a.prev():39==d.keyCode?a.next():0!=d.keyCode&&(27==d.keyCode?a.viewer().hasClass("fullmode")?a.fullHide():a.hide():109==d.keyCode||38==d.keyCode?
a.zoom(2):(107==d.keyCode||40==d.keyCode)&&a.zoom(-2)))});this.viewer().find(".wpPhoto").mousewheel(function(b){if(!a.viewer().hasClass("tagging_process")){b=b.originalEvent;var c=0;b.wheelDelta&&(c=b.wheelDelta/120);b.detail&&(c=-b.detail/3);a.zoom(c)}});this.viewer().click(function(c){!b(c.target).closest(".external-options").length&&(!b(c.target).hasClass("actions")&&!b(c.target).parent().hasClass("actions"))&&a.hideOptions()});document.addEventListener&&(document.addEventListener("fullscreenchange",
function(){},!1),document.addEventListener("mozfullscreenchange",function(){a.fullToggle(document.mozFullScreen)},!1),document.addEventListener("webkitfullscreenchange",function(){a.fullToggle(document.webkitIsFullScreen)},!1))}},fullToggle:function(a){a?this.fullOpen():this.fullHide()},zoom:function(a){if(!this.isListActive())if(a/=this.options.scale_step,this.scale+=a,this.scale<this.options.min_scale)this.viewer().removeClass("zooming"),this.scale-=a;else if(this.scale>this.options.max_scale)this.scale-=
a;else if(this.viewer().addClass("zooming"),b("#wpPhotoViewer").find(".wpPhoto").find(".active").css("-moz-transform","scale("+this.scale+")").css("-webkit-transform","scale("+this.scale+")").css("transform","scale("+this.scale+")"),a=this.getInternetExplorerVersion(),7==a||8==a)a=b("#wpPhotoViewer").find(".wpPhoto").find(".active").find("img"),a.data("original-width")||(a.data("original-width",a.width()),a.data("original-height",a.height())),a.css("width",a.data("original-width")*this.scale).css("height",
a.data("original-height")*this.scale)},getInternetExplorerVersion:function(){var a=-1;"Microsoft Internet Explorer"==navigator.appName&&null!=/MSIE ([0-9]{1,}[.0-9]{0,})/.exec(navigator.userAgent)&&(a=parseFloat(RegExp.$1));return a},noZoom:function(a){a?this.viewer().addClass("nozoom"):this.viewer().removeClass("nozoom")},fullOpen:function(){var a=this.viewer();a.addClass("fullmode");this.resize();a=a[0];a.requestFullScreen&&a.requestFullScreen();a.webkitRequestFullScreen&&a.webkitRequestFullScreen();
a.mozRequestFullScreen&&a.mozRequestFullScreen();a.requestFullscreen&&a.requestFullscreen()},fullHide:function(){this.viewer().removeClass("fullmode");this.resize();this.stopSlideshow();this.viewer().removeClass("slideshow_process");this.viewer().find(".wpSlideshow").hide();document.cancelFullScreen&&document.cancelFullScreen();document.webkitCancelFullScreen&&document.webkitCancelFullScreen();document.mozCancelFullScreen&&document.mozCancelFullScreen();document.exitFullscreen&&document.exitFullscreen()},
viewer:function(){var a=this;if(this.is_viewer)return this.c;this.is_viewer=!0;var c=b("<div />");c.attr({id:"wpPhotoViewer","class":"wpPhotoViewer"});c.html(this.getHtmlContent());c.appendTo(b("body"));var d=this.getInternetExplorerVersion();-1!==d&&(c.addClass("wpIe"),c.addClass("wpIe"+d));clearTimeout(a.mouseTimer);c.mouseover(function(){clearTimeout(a.mouseTimer);a.mouseTimer=setTimeout(function(){a.viewer().addClass("mouseActive");clearTimeout(a.mouseTimerOut);a.mouseTimerOut=setTimeout(function(){a.viewer().removeClass("mouseActive")},
2E3)},10)});var e=c.find(".wpPhotoContent");e.unbind("mousemove").mousemove(function(c){if(!b(c.target).closest("#lassoMask").length&&!b(c.target).parents("#lassoMask"))return a.is_pressed&&(clearInterval(a.moving_timer),a.moving_timer=setTimeout(function(){var b=a.move.startClientX-c.clientX,d=a.move.startClientY-c.clientY;a.move.startClientX=c.clientX;a.move.startClientY=c.clientY;a.photoMove(b,d)},1)),!1});e.unbind("mousedown").mousedown(function(c){if(!b(c.target).closest("#lassoMask").length&&
!b(c.target).parents("#lassoMask"))return a.is_pressed=!0,a.move.startClientX=c.clientX,a.move.startClientY=c.clientY,e.addClass("moving"),!1});e.unbind("mouseup").mouseup(function(c){if(!b(c.target).closest("#lassoMask").length)return a.is_pressed=!1,e.removeClass("moving"),!1});e.unbind("mouseout").mouseout(function(c){if(!b(c.target).closest("#lassoMask").length)return a.is_pressed=!1,e.removeClass("moving"),!1});return this.c=c},photoMove:function(a,c){var d=b("#thephoto_"+this.getActiveId());
this.move.top+=1.5*-c;this.move.left+=1.5*-a;d.css("margin-top",this.move.top);d.css("margin-left",this.move.left)},showOver:function(){var a=this;this.viewer().find(".wpOver").show();clearTimeout(this.timeout);this.timeout=setTimeout(function(){a.viewer().find(".wpOver").addClass("active")},100)},hideOver:function(){var a=this;a.viewer().find(".wpOver").removeClass("active");clearTimeout(this.timeout);this.timeout=setTimeout(function(){a.viewer().find(".wpOver").hide()},500)},slideshow:function(){this.fullOpen();
this.startSlideshow()},slideshowClose:function(){this.stopSlideshow();this.fullHide();this.viewer().removeClass("slideshow_process");this.viewer().find(".wpSlideshow").hide()},startSlideshow:function(){var a=this;this.stopSlideshow();this.slideshow_is_pause=this.slideshow_is_stop=!1;this.viewer().addClass("slideshow_process");this.slideshow_timer=setInterval(function(){a.slideshow_is_pause||a.next(function(){a.stopSlideshow()})},this.options.slideshow_time);this._checkStatusSlideShow()},stopSlideshow:function(){clearInterval(this.slideshow_timer);
this.slideshow_is_stop=!0;this._checkStatusSlideShow()},repeatSlideshow:function(){this.viewer().find(".photos").find("a:first").click();this.startSlideshow();this._checkStatusSlideShow()},_checkStatusSlideShow:function(){this.slideshow_is_pause?(this.viewer().find(".wpSlidStart").show(),this.viewer().find(".wpSlidPause").hide(),this.viewer().find(".wpSlidRepeat").hide()):this.slideshow_is_stop?(this.viewer().find(".wpSlidStart").hide(),this.viewer().find(".wpSlidPause").hide(),this.viewer().find(".wpSlidRepeat").show()):
(this.viewer().find(".wpSlidStart").hide(),this.viewer().find(".wpSlidPause").show(),this.viewer().find(".wpSlidRepeat").hide())},pauseSlideshow:function(){this.slideshow_is_pause=!0;this._checkStatusSlideShow()},hideOptions:function(){b("#photo_comment_"+this.getActiveId()).find(".external-options").hide()},toggleOptions:function(){var a=b("#photo_comment_"+this.getActiveId()).find(".external-options");a.toggle();var c=this.viewer().find(".actions").offset();left_size=0==c.left?149:c.left;a.css("top",
32).css("left",left_size)},getActiveId:function(){var a=this.viewer().find(".photos").find(".active");if(a.length)return a.attr("id").substr(3)},getActive:function(){return this.photos[this.getActiveId()]},getHtmlContent:function(){return'<div class="wpContainer"><a href="javascript:void(0);" class="wpPrev hei hei-angle-left" onclick="PhotoViewer.prev();" style="display: none;"></a><a href="javascript:void(0);" class="wpNext icon-angle-right" onclick="PhotoViewer.next();" style="display: none;"></a><a href="javascript:void(0);" class="wpClose icon-remove" onclick="PhotoViewer.hide();"></a><div class="wpPhoto"><table width="100%" class="wpPhotoContentTable"><tr><td align="center" valign="center" class="wpPhotoContent"></td></tr></table></div><div class="wpComments"><div class="wpCommentsContent"><div class="photo_comment loadingComments"><div class="layout_page_photoviewer_index_comments"><div class="generic_layout_container layout_main"><span class="loading">'+
en4.core.language.translate("PHOTOVIEWER_loading")+'</span></div></div></div></div></div><div class="wpBar"><div class="wpPhotoList"><div class="title">'+en4.core.language.translate("PHOTOVIEWER_All photos")+'&nbsp;(<span class="count">0</span>)<a href="javascript:void(0);" onclick="PhotoViewer.hideList();" class="wpListClose"><i class="hei hei-times"></i></a></div><div class="photos"></div></div><div class="wpPhotoOptions"><div class="leftside"><a href="javascript:void(0);" class="wpbtn wpbtn-inverse allPhotos" onclick="PhotoViewer.toggleList();" style="display: none;">'+
en4.core.language.translate("PHOTOVIEWER_All photos")+'<i class="right hei hei-caret-up"></i></a><a href="javascript:void(0);" class="wpbtn wpbtn-inverse goSlideshow" onclick="PhotoViewer.slideshow();" style="display: none;">'+en4.core.language.translate("PHOTOVIEWER_Slideshow")+'</a><div class="info" style="display: none;"><div class="album_info"><span class="album_title"></span><span class="album_owner"></span></div><div class="count"><span class="current"></span>&nbsp;'+en4.core.language.translate("PHOTOVIEWER_from")+
'&nbsp;<span class="total"></span></div></div></div></div></div></div><div class="wpSlideshow" style="display: none;"><a href="javascript:void(0);" onclick="PhotoViewer.startSlideshow();" style="display: none;" class="wpSlidStart wpbtn wpbtn-inverse">'+en4.core.language.translate("PHOTOVIEWER_Play")+'</a><a href="javascript:void(0);" onclick="PhotoViewer.pauseSlideshow();" style="display: none;" class="wpSlidPause wpbtn wpbtn-inverse">'+en4.core.language.translate("PHOTOVIEWER_Pause")+'</a><a href="javascript:void(0);" onclick="PhotoViewer.repeatSlideshow();" style="display: none;" class="wpSlidRepeat wpbtn wpbtn-inverse">'+
en4.core.language.translate("PHOTOVIEWER_Repeat")+'</a><a href="javascript:void(0);" onclick="PhotoViewer.slideshowClose();" class="wpSlidClose wpbtn wpbtn-inverse"><i class="hei hei-times"></i></a></div><div class="wpOver" onclick="PhotoViewer.hideList();" style="display: none;"></div>'},reset:function(){this.viewer().find(".photos").jScrollPane().data("jsp").destroy();this.viewer().find(".wpOver, .wpNext, .wpPrev, .info, .allPhotos, .goSlideshow, .wpSlideshow, .wpSlidStart, .wpSlidPause, .wpSlidRepeat").hide();
this.viewer().find(".wpPhotoContent, .photos").empty();this.viewer().find(".wpCommentsContent").children().hide();this.viewer().removeClass("fullmode").removeClass("zooming").removeClass("slideshow_process").removeClass("mouseActive");this.viewer().find(".wpPhotoList").removeClass(".one_col");this.viewer().find(".wpCommentsContent").children(".loadingComments").show();return this.viewer()},showLoading:function(){this.viewer().find(".wpCommentsContent").children().hide();this.viewer().find(".wpCommentsContent").children(".loadingComments").show()},
hideLoading:function(){this.viewer().find(".wpCommentsContent").children(".loadingComments").hide()},bindPhotoViewer:function(){b&&b("#global_content").find("a").not(".wp_init").addClass("wp_init").each(function(a,c){var d=b(c).attr("href");if(d&&"javascript:void(0)"!=d){var e=0,f=d.match(/album_id\/([0-9]{0,})\/*\/photo_id\/([0-9]{0,})/i);f||(f=d.match(/content\/pagealbumphoto\/album_id\/([0-9]{0,})\/content_id\/([0-9]{0,})/i),e=1);-1<d.indexOf("groups")&&(-1<d.indexOf("group_id")&&-1<d.indexOf("album_id")&&
-1<d.indexOf("photo_id"))&&(e=2);!f||!f[0]||!f[1]||!f[2]?(f=d.match(/event_id\/([0-9]{0,})\/*\/photo_id\/([0-9]{0,})/i),events=1):events=2;if(f&&f[0]&&f[1]&&f[2]){d=f[1];f=f[2];$(c).removeEvents();var g=$(c).getElement("img");g&&g.removeEvents("click");b(c).attr("onclick","").data("album_id",d).data("photo_id",f).data("isPage",e).data("events",events).click(function(a){a.stopPropagation();a.preventDefault();PhotoViewer.open({album_id:b(this).data("album_id"),photo_id:b(this).data("photo_id"),isPage:b(this).data("isPage"),
events:b(this).data("events")})})}}})}}})(photoViewerJquery,window);
